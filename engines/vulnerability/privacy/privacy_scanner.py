# engines/vulnerability/privacy/privacy_scanner.py

import os
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


class PrivacyScanner:
    """
    M6 â€“ Inadequate Privacy Controls (Refined)
    """

    FRAMEWORK_PREFIXES = (
        "androidx/",
        "kotlin/",
        "android/support/",
        "android/compose/",
    )

    PII_SOURCES = {
        "device_identifier": [
            "telephonymanager->getdeviceid",
            "telephonymanager->getimei",
            "settings$secure->getstring",
            "android_id",
        ],
        "location": [
            "getlastknownlocation",
            "requestlocationupdates",
            "fusedlocationproviderclient",
        ],
        "advertising_id": [
            "advertisingidclient",
            "getadvertisingidinfo",
        ],
    }

    NETWORK_SINKS = [
        "okhttp",
        "httpurlconnection",
        "retrofit",
        "volley",
        "addheader",
        "setrequestproperty",
    ]

    def scan(self, smali_root: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        for root, _, files in os.walk(smali_root):
            for f in files:
                if not f.endswith(".smali"):
                    continue

                path = os.path.join(root, f)
                rel_path = path.replace(smali_root, "").lstrip("/")

                # ðŸ”¥ FILTER FRAMEWORK
                if rel_path.startswith(self.FRAMEWORK_PREFIXES):
                    continue

                try:
                    with open(path, "r", encoding="utf-8", errors="ignore") as fh:
                        lines = fh.readlines()
                except Exception:
                    continue

                for idx, line in enumerate(lines):
                    l = line.lower()

                    for pii_type, sources in self.PII_SOURCES.items():
                        if any(src in l for src in sources) and any(
                            net in l for net in self.NETWORK_SINKS
                        ):
                            signals.append(
                                VulnerabilitySignal(
                                    owasp_id="M6",
                                    category="INADEQUATE_PRIVACY_CONTROLS",
                                    subtype=f"{pii_type}_sent_over_network",
                                    source="smali",
                                    file=rel_path,
                                    line=idx + 1,
                                    code=line.strip(),
                                    evidence=[line.strip()],
                                    confidence=0.85,
                                )
                            )

        return signals
