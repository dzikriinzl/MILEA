# engines/vulnerability/taxonomy.py

# Severity numeric weights used for scoring (0-10 scale)
SEVERITY_SCORE = {
    "CRITICAL": 9.5,
    "HIGH":     7.5,
    "MEDIUM":   5.0,
    "LOW":      2.5,
    "INFO":     1.0,
}

VULNERABILITY_TAXONOMY = {
    # ── M1: Improper Credential Usage ─────────────────────────────────
    "M1": {
        "title": "M1 — Improper Credential Usage",
        "severity": "HIGH",
        "owasp": "M1",
        "cwe": "CWE-798",
        "description": (
            "Hardcoded or improperly managed credentials found in application code. "
            "Attackers can extract secrets by decompiling the APK. "
            "Note: When only token/session-identifier patterns are detected without "
            "real hardcoded secrets, the risk assessment is adjusted accordingly."
        ),
        "remediation": (
            "Remove hardcoded secrets. Use Android Keystore for sensitive data. "
            "Rotate any exposed credentials immediately."
        ),
    },
    # ── M2: Inadequate Supply Chain Security ──────────────────────────
    "M2": {
        "title": "M2 — Inadequate Supply Chain Security",
        "severity": "HIGH",
        "owasp": "M2",
        "cwe": "CWE-829",
        "description": (
            "Third-party libraries or SDKs included may contain known vulnerabilities, "
            "expanding the attack surface."
        ),
        "remediation": (
            "Audit all dependencies. Pin library versions and verify checksums. "
            "Use tools like dependency-check or OWASP Dependency-Track."
        ),
    },
    # ── M3: Insecure Authentication / Authorization ───────────────────
    "M3": {
        "title": "M3 — Insecure Authentication / Authorization",
        "severity": "HIGH",
        "owasp": "M3",
        "cwe": "CWE-287",
        "description": (
            "Authentication tokens appear to be stored or validated insecurely, "
            "enabling session hijacking or privilege escalation."
        ),
        "remediation": (
            "Use strong token algorithms (JWT RS256/EdDSA). "
            "Enforce server-side validation for all auth decisions."
        ),
    },
    # ── M4: Insufficient Input / Output Validation ────────────────────
    "M4": {
        "title": "M4 — Insufficient Input / Output Validation",
        "severity": "MEDIUM",
        "owasp": "M4",
        "cwe": "CWE-20",
        "description": (
            "User-supplied data processed without adequate validation may enable "
            "injection or logic-bypass attacks."
        ),
        "remediation": (
            "Apply strict allowlist input validation. Sanitize all external data. "
            "Use parameterized queries for database access."
        ),
    },
    # ── M5: Insecure Communication ────────────────────────────────────
    "M5": {
        "title": "M5 — Insecure Communication",
        "severity": "HIGH",
        "owasp": "M5",
        "cwe": "CWE-319",
        "description": (
            "Application permits cleartext traffic or trusts untrusted CAs, "
            "exposing users to MITM interception."
        ),
        "remediation": (
            "Enforce TLS 1.2+. Set cleartextTrafficPermitted=false. "
            "Implement certificate pinning."
        ),
    },
    # ── M6: Inadequate Privacy Controls ───────────────────────────────
    "M6": {
        "title": "M6 — Inadequate Privacy Controls",
        "severity": "HIGH",
        "owasp": "M6",
        "cwe": "CWE-359",
        "description": (
            "PII (device ID, location, advertising ID) collected or transmitted "
            "without adequate consent or protection."
        ),
        "remediation": (
            "Minimise PII collection. Encrypt PII in transit and at rest. "
            "Provide clear privacy disclosures."
        ),
    },
    # ── M7: Insufficient Binary Protections ───────────────────────────
    "M7": {
        "title": "M7 — Insufficient Binary Protections",
        "severity": "MEDIUM",
        "owasp": "M7",
        "cwe": "CWE-693",
        "description": (
            "Aggregated indicators suggest inadequate binary hardening posture, "
            "potentially facilitating reverse engineering."
        ),
        "remediation": (
            "Enable ProGuard/R8 obfuscation. Integrate RASP. "
            "Enforce code signing validation at runtime."
        ),
    },
    # ── M8: Security Misconfiguration ─────────────────────────────────
    "M8": {
        "title": "M8 — Security Misconfiguration",
        "severity": "MEDIUM",
        "owasp": "M8",
        "cwe": "CWE-16",
        "description": (
            "Insecure manifest settings (debuggable=true, allowBackup=true, "
            "exported components) expand the attack surface."
        ),
        "remediation": (
            "Disable debuggable and allowBackup in production. "
            "Restrict exported components with explicit permissions."
        ),
    },
    # ── M9: Insecure Data Storage ─────────────────────────────────────
    "M9": {
        "title": "M9 — Insecure Data Storage",
        "severity": "HIGH",
        "owasp": "M9",
        "cwe": "CWE-922",
        "description": (
            "Sensitive data stored in plaintext SharedPreferences, world-readable "
            "files, or external storage without encryption."
        ),
        "remediation": (
            "Use EncryptedSharedPreferences or Android Keystore for all "
            "sensitive data. Avoid external storage for secrets."
        ),
    },
    # ── M10: Insufficient Cryptography ────────────────────────────────
    "M10": {
        "title": "M10 — Insufficient Cryptography",
        "severity": "HIGH",
        "owasp": "M10",
        "cwe": "CWE-327",
        "description": (
            "Deprecated or broken algorithms (MD5, SHA1, AES/ECB, DES) provide "
            "inadequate security."
        ),
        "remediation": (
            "Replace with AES/GCM, SHA-256+, and TLS 1.3. "
            "Use authenticated encryption for data integrity."
        ),
    },
    # ── Legacy keys (backward compat) ─────────────────────────────────
    "HARDCODED_SECRET": {
        "title": "Hardcoded Secret",
        "owasp": "M9",
        "cwe": "CWE-798",
        "severity": "HIGH",
        "description": "Hardcoded secrets found in application code.",
        "remediation": "Remove hardcoded secrets. Use Android Keystore.",
    },
    "INSECURE_CRYPTO": {
        "title": "Insecure Cryptography",
        "owasp": "M5",
        "cwe": "CWE-327",
        "severity": "HIGH",
        "description": "Weak or deprecated cryptographic algorithms used.",
        "remediation": "Replace with modern algorithms (AES-GCM, SHA-256+).",
    },
}
