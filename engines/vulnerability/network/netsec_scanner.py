# engines/vulnerability/network/netsec_scanner.py

import os
import xml.etree.ElementTree as ET
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


class NetworkSecurityConfigScanner:
    """
    Scan network_security_config.xml for insecure TLS settings.
    OWASP M5 â€“ Insecure Communication
    """

    def scan(self, netsec_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        if not os.path.exists(netsec_path):
            return signals

        try:
            tree = ET.parse(netsec_path)
            root = tree.getroot()
        except Exception:
            return signals

        # --- Rule 1: cleartextTrafficPermitted ---
        for domain_cfg in root.findall(".//domain-config"):
            if domain_cfg.get("cleartextTrafficPermitted") == "true":
                signals.append(
                    VulnerabilitySignal(
                        owasp_id="M5",
                        category="INSECURE_COMMUNICATION",
                        subtype="cleartext_permitted",
                        source="network_security_config",
                        file=netsec_path,
                        evidence=[
                            "cleartextTrafficPermitted=true"
                        ],
                        confidence=0.9,
                    )
                )

        # --- Rule 2: Trust user-added CAs ---
        for trust in root.findall(".//trust-anchors"):
            for cert in trust.findall("certificates"):
                if cert.get("src") == "user":
                    signals.append(
                        VulnerabilitySignal(
                            owasp_id="M5",
                            category="INSECURE_COMMUNICATION",
                            subtype="user_ca_trusted",
                            source="network_security_config",
                            file=netsec_path,
                            evidence=[
                                "trust-anchors user certificates"
                            ],
                            confidence=0.85,
                        )
                    )

        # --- Rule 3: Debug overrides ---
        for dbg in root.findall(".//debug-overrides"):
            signals.append(
                VulnerabilitySignal(
                    owasp_id="M5",
                    category="INSECURE_COMMUNICATION",
                    subtype="debug_override_trust",
                    source="network_security_config",
                    file=netsec_path,
                    evidence=["debug-overrides present"],
                    confidence=0.7,
                )
            )

        return signals
