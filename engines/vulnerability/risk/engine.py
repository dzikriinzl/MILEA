# engines/vulnerability/risk/engine.py
from typing import List, Dict, Any


class RiskScoringEngine:
    """
    STAGE 4: Risk Scoring Engine
    Input: List[CorrelatedFinding]
    Output: {numeric, level, explanation}
    Responsibility:
      - Aggregate effective risk
      - Explain why
    """

    SEVERITY_WEIGHT = {
        "CRITICAL": 4,
        "HIGH": 3,
        "MEDIUM": 2,
        "LOW": 1,
    }

    def __init__(self):
        pass

    def calculate(self, correlated_findings: List) -> Dict[str, Any]:
        """
        Calculate aggregate risk from correlated findings
        Returns {numeric, level, explanation}
        """
        if not correlated_findings:
            return {
                "numeric": 0,
                "level": "LOW",
                "explanation": ["No vulnerabilities found"],
            }

        total_score = 0
        mitigated_count = 0
        explanations = []

        for finding in correlated_findings:
            # Get weight from effective risk
            weight = self.SEVERITY_WEIGHT.get(finding.effective_risk, 1)
            total_score += weight

            # Track mitigated findings
            if finding.mitigation_status == "MITIGATED":
                mitigated_count += 1

            # Add explanation per finding
            explanations.append(
                f"{finding.owasp_id} {finding.title}: {finding.effective_risk} ({finding.mitigation_status})"
            )

        # Determine risk level
        risk_level = self._level(total_score)

        # Prepend summary explanations
        explanations.insert(
            0,
            f"{mitigated_count}/{len(correlated_findings)} findings mitigated"
        )
        explanations.insert(
            0,
            f"Overall application risk is {risk_level}"
        )

        return {
            "numeric": total_score,
            "level": risk_level,
            "explanation": explanations,
        }

    def _level(self, score: int) -> str:
        """Convert numeric score to risk level"""
        if score <= 5:
            return "LOW"
        elif score <= 10:
            return "MEDIUM"
        else:
            return "HIGH"
