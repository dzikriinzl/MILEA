from typing import List
from engines.vulnerability.risk.models import RiskScore


class RiskScoringEngine:
    """
    M-ILEA Risk Scoring Engine

    Uses:
    - Effective risk (after correlation)
    - Mitigation status
    - Confidence
    """

    SEVERITY_WEIGHT = {
        "LOW": 1,
        "MEDIUM": 3,
        "HIGH": 7,
        "CRITICAL": 10,
    }

    MITIGATION_MULTIPLIER = {
        "MITIGATED": 0.3,
        "PARTIAL": 0.6,
        "NONE": 1.0,
    }

    def calculate(self, correlated_findings: List) -> RiskScore:
        """
        Calculate final app risk score
        """

        total_risk = 0.0
        explanation = []

        if not correlated_findings:
            return RiskScore(
                numeric=0,
                level="LOW",
                explanation=["No vulnerabilities detected"],
            )

        for f in correlated_findings:
            sev = f.effective_risk
            mitigation = f.mitigation_status
            confidence = f.original_finding.get("confidence", 0.5)

            base = self.SEVERITY_WEIGHT.get(sev, 1)
            multiplier = self.MITIGATION_MULTIPLIER.get(mitigation, 1.0)

            risk = base * multiplier * confidence
            total_risk += risk

            explanation.append(
                f"{f.owasp_id} {f.title}: {sev} "
                f"({mitigation}, confidence={confidence:.2f})"
            )

        normalized = min(100, round(total_risk))

        return RiskScore(
            numeric=normalized,
            level=self._level(normalized),
            explanation=self._summarize(normalized, correlated_findings, explanation),
        )

    # --------------------------------------------------

    def _level(self, score: int) -> str:
        if score <= 20:
            return "LOW"
        if score <= 40:
            return "MEDIUM"
        if score <= 70:
            return "HIGH"
        return "CRITICAL"

    def _summarize(self, score: int, findings: List, raw: List[str]) -> List[str]:
        summary = []

        if score <= 20:
            summary.append("Overall application risk is LOW")
        elif score <= 40:
            summary.append("Application has moderate security risks")
        elif score <= 70:
            summary.append("Application is at HIGH risk")
        else:
            summary.append("Application is CRITICALLY vulnerable")

        mitigated = sum(1 for f in findings if f.mitigation_status == "MITIGATED")
        summary.append(f"{mitigated}/{len(findings)} findings mitigated by protections")

        # Add top 3 technical reasons
        summary.extend(raw[:3])

        return summary
