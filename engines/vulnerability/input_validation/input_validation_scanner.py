# engines/vulnerability/input_validation/input_validation_scanner.py

import os
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


class InputValidationScanner:
    """
    M4 â€“ Insufficient Input / Output Validation
    Smali-level signal scanner
    """

    SIGNALS = {
        "webview_js_interface": [
            "addjavascriptinterface",
            "@javascriptinterface",
        ],
        "intent_extra_unvalidated": [
            "getintent",
            "getstringextra",
            "getserializableextra",
            "getextras",
        ],
        "uri_unvalidated": [
            "getdata",
            "getqueryparameter",
        ],
        "webview_load_untrusted": [
            "loadurl",
            "loaddata",
            "loaddatawithbaseurl",
        ],
    }

    def scan(self, smali_root: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        for root, _, files in os.walk(smali_root):
            for f in files:
                if not f.endswith(".smali"):
                    continue

                path = os.path.join(root, f)
                rel_path = path.replace(smali_root, "").lstrip("/")

                try:
                    with open(path, "r", encoding="utf-8", errors="ignore") as fh:
                        lines = fh.readlines()
                except Exception:
                    continue

                for idx, line in enumerate(lines):
                    l = line.lower()

                    for subtype, keywords in self.SIGNALS.items():
                        if any(k in l for k in keywords):
                            signals.append(
                                VulnerabilitySignal(
                                    owasp_id="M4",
                                    category="INSUFFICIENT_INPUT_VALIDATION",
                                    subtype=subtype,
                                    source="smali",
                                    file=rel_path,
                                    line=idx + 1,
                                    code=line.strip(),
                                    evidence=[line.strip()],
                                    confidence=0.6,
                                )
                            )

        return signals
