# engines/vulnerability/crypto/weak_crypto_scanner.py

import os
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


class WeakCryptographyScanner:
    """
    M10 â€“ Insufficient Cryptography (Weak Crypto Usage)
    Signal-based scanner (NO enforcement logic)
    """

    WEAK_PATTERNS = {
        "weak_hash_md5": ["md5"],
        "weak_hash_sha1": ["sha1"],
        "insecure_cipher_ecb": ["aes/ecb"],
        "deprecated_crypto": ["cipher.getinstance"],
    }

    def scan(self, smali_root: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        for root, _, files in os.walk(smali_root):
            for f in files:
                if not f.endswith(".smali"):
                    continue

                path = os.path.join(root, f)
                rel_path = path.replace(smali_root, "").lstrip("/")

                try:
                    with open(path, "r", encoding="utf-8", errors="ignore") as fh:
                        lines = fh.readlines()
                except Exception:
                    continue

                for idx, line in enumerate(lines):
                    l = line.lower()

                    for subtype, keywords in self.WEAK_PATTERNS.items():
                        if any(k in l for k in keywords):
                            signals.append(
                                VulnerabilitySignal(
                                    owasp_id="M10",
                                    category="INSUFFICIENT_CRYPTOGRAPHY",
                                    subtype=subtype,
                                    source="smali",
                                    file=rel_path,
                                    line=idx + 1,
                                    code=line.strip(),
                                    evidence=[line.strip()],
                                    confidence=0.6,
                                )
                            )

        return signals
