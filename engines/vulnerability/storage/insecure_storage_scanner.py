# engines/vulnerability/storage/insecure_storage_scanner.py

import os
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


class InsecureDataStorageScanner:
    """
    M9 â€“ Insecure Data Storage
    Detects plaintext local storage usage.
    """

    STORAGE_PATTERNS = {
        "sharedprefs_plaintext": [
            "getsharedpreferences",
            "edit()",
            "putstring",
        ],
        "world_readable_storage": [
            "mode_world_readable",
            "mode_world_writeable",
        ],
        "external_storage_access": [
            "getexternalstoragedirectory",
            "externalstorage",
        ],
        "sqlite_plaintext": [
            "sqliteopenhelper",
            "openorcreatedatabase",
        ],
    }

    def scan(self, smali_root: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        for root, _, files in os.walk(smali_root):
            for f in files:
                if not f.endswith(".smali"):
                    continue

                path = os.path.join(root, f)
                rel_path = path.replace(smali_root, "").lstrip("/")

                try:
                    with open(path, "r", encoding="utf-8", errors="ignore") as fh:
                        lines = fh.readlines()
                except Exception:
                    continue

                for idx, line in enumerate(lines):
                    l = line.lower()

                    for subtype, keywords in self.STORAGE_PATTERNS.items():
                        if any(k in l for k in keywords):
                            signals.append(
                                VulnerabilitySignal(
                                    owasp_id="M9",
                                    category="INSECURE_DATA_STORAGE",
                                    subtype=subtype,
                                    source="smali",
                                    file=rel_path,
                                    line=idx + 1,
                                    code=line.strip(),
                                    evidence=[line.strip()],
                                    confidence=0.6,
                                )
                            )

        return signals
