from datetime import datetime


class UnifiedHTMLReportGenerator:
    """
    FINAL HTML Generator â€“ M-ILEA
    Pretty, readable, MobSF-style
    """

    def generate(self, report: dict) -> str:
        now = datetime.utcnow().isoformat()

        vulns_html = self._render_vulnerabilities(
            report.get("correlated_findings", [])
        )

        return f"""
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>M-ILEA Security Report</title>
<style>
body {{
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 24px;
}}
h1, h2 {{ color: #38bdf8; }}
.card {{
  background: #020617;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}}
.badge {{
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
}}
.low {{ color: #22c55e; }}
.medium {{ color: #facc15; }}
.high {{ color: #ef4444; }}
.mitigated {{ color: #22c55e; }}
.none {{ color: #ef4444; }}
</style>
</head>
<body>

<h1>M-ILEA Unified Security Report</h1>
<p>Generated: {now}</p>

<div class="card">
<h2>Risk Score</h2>
<p><b>Level:</b> <span class="{report['risk_score']['level'].lower()}">
{report['risk_score']['level']}
</span></p>
<p><b>Score:</b> {report['risk_score']['numeric']}</p>
<ul>
{''.join(f"<li>{e}</li>" for e in report['risk_score']['explanation'])}
</ul>
</div>

<div class="card">
<h2>Vulnerability Findings</h2>
{vulns_html}
</div>

</body>
</html>
"""

    # --------------------------------------------------

    def _render_vulnerabilities(self, findings: list) -> str:
        if not findings:
            return "<p>No vulnerabilities detected.</p>"

        blocks = []

        for f in findings:
            sev_class = f.effective_risk.lower()
            mit_class = f.mitigation_status.lower()

            blocks.append(f"""
<div class="card">
  <h3>[{f.owasp_id}] {f.title}</h3>
  <p>
    <b>Base Severity:</b> {f.base_severity}<br/>
    <b>Effective Risk:</b>
    <span class="{sev_class}">{f.effective_risk}</span><br/>
    <b>Mitigation:</b>
    <span class="{mit_class}">{f.mitigation_status}</span><br/>
    <b>Confidence:</b> {f.original_finding.get('confidence', 0):.2f}
  </p>
  <b>Reasoning:</b>
  <ul>
    {''.join(f"<li>{r}</li>" for r in f.reasoning)}
  </ul>
</div>
""")

        return "\n".join(blocks)
