# engines/vulnerability/correlation/models.py

from dataclasses import dataclass
from typing import Dict, List, Any


@dataclass
class CorrelatedFinding:
    owasp_id: str
    title: str

    base_severity: str
    effective_risk: str
    mitigation_status: str

    reasoning: List[str]

    original_finding: Any

    # ------------------------------------------------------------------
    # Serialisation â€” merges original finding data with correlation data
    # so the report builder and HTML renderer get a complete dict.
    # ------------------------------------------------------------------
    def as_dict(self) -> Dict[str, Any]:
        # Start from the original finding (already a dict from VulnerabilityFinding.as_dict())
        if isinstance(self.original_finding, dict):
            base = dict(self.original_finding)
        elif hasattr(self.original_finding, "as_dict"):
            base = self.original_finding.as_dict()
        else:
            base = {}

        # Override / add correlation-specific fields
        base.update({
            "owasp_id": self.owasp_id,
            "title": self.title,
            "severity": self.effective_risk,       # post-mitigation severity
            "base_severity": self.base_severity,
            "effective_risk": self.effective_risk,
            "mitigation_status": self.mitigation_status,
            "reasoning": self.reasoning,
        })

        # Guarantee keys the HTML renderer requires
        base.setdefault("confidence", 0.8)
        base.setdefault("description", "")
        base.setdefault("remediation", "")
        base.setdefault("recommendation", "")
        base.setdefault("evidence", [])
        base.setdefault("affected_files", [])

        return base