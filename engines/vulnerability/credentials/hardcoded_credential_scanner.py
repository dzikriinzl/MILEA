# engines/vulnerability/credentials/hardcoded_credential_scanner.py

import os
import re
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


class HardcodedCredentialScanner:
    """
    M1 – Improper Credential Usage
    Detects hardcoded credentials in smali code.
    Signal-based scanner (NO enforcement logic)
    """

    # keyword → subtype
    CREDENTIAL_PATTERNS = {
        "hardcoded_password": [
            r"password",
            r"passwd",
            r"pwd",
        ],
        "hardcoded_api_key": [
            r"api[_-]?key",
            r"apikey",
        ],
        "hardcoded_secret": [
            r"secret",
            r"client[_-]?secret",
        ],
        "hardcoded_token": [
            r"token",
            r"bearer",
        ],
        "hardcoded_auth_header": [
            r"authorization",
            r"auth:",
        ],
    }

    STRING_INSTRUCTION = "const-string"

    def scan(self, smali_root: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        for root, _, files in os.walk(smali_root):
            for f in files:
                if not f.endswith(".smali"):
                    continue

                path = os.path.join(root, f)
                rel_path = path.replace(smali_root, "").lstrip("/")

                try:
                    with open(path, "r", encoding="utf-8", errors="ignore") as fh:
                        lines = fh.readlines()
                except Exception:
                    continue

                for idx, line in enumerate(lines):
                    l = line.lower()

                    # only focus on literal strings
                    if self.STRING_INSTRUCTION not in l:
                        continue

                    for subtype, patterns in self.CREDENTIAL_PATTERNS.items():
                        for p in patterns:
                            if re.search(p, l):
                                signals.append(
                                    VulnerabilitySignal(
                                        owasp_id="M1",
                                        category="IMPROPER_CREDENTIAL_USAGE",
                                        subtype=subtype,
                                        source="smali",
                                        file=rel_path,
                                        line=idx + 1,
                                        code=line.strip(),
                                        evidence=[line.strip()],
                                        confidence=0.65,
                                    )
                                )
                                break

        return signals
