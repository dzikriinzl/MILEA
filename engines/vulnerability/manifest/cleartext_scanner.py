# engines/vulnerability/manifest/cleartext_scanner.py

import xml.etree.ElementTree as ET
from typing import List
from engines.vulnerability.models import VulnerabilitySignal

ANDROID_NS = "{http://schemas.android.com/apk/res/android}"


class CleartextTrafficScanner:
    """
    Detect cleartext traffic allowance in AndroidManifest.xml
    OWASP M5 â€“ Insecure Communication
    """

    def scan(self, manifest_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        tree = ET.parse(manifest_path)
        root = tree.getroot()

        app = root.find("application")
        if app is None:
            return signals

        uses_cleartext = app.get(ANDROID_NS + "usesCleartextTraffic")
        netsec_config = app.get(ANDROID_NS + "networkSecurityConfig")

        # ---------- Rule 1: Explicit cleartext ----------
        if uses_cleartext == "true":
            signals.append(
                VulnerabilitySignal(
                    owasp_id="M5",
                    category="INSECURE_COMMUNICATION",
                    subtype="cleartext_traffic_enabled",
                    source="manifest",
                    file=manifest_path,
                    evidence=[
                        "usesCleartextTraffic=true",
                    ],
                    confidence=0.9,
                )
            )

        # ---------- Rule 2: No Network Security Config ----------
        if netsec_config is None:
            signals.append(
                VulnerabilitySignal(
                    owasp_id="M5",
                    category="INSECURE_COMMUNICATION",
                    subtype="missing_network_security_config",
                    source="manifest",
                    file=manifest_path,
                    evidence=[
                        "networkSecurityConfig=NONE",
                    ],
                    confidence=0.6,
                )
            )

        return signals
