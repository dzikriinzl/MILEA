# engines/vulnerability/manifest/exported_scanner.py

import xml.etree.ElementTree as ET
from typing import List
from engines.vulnerability.models import VulnerabilitySignal


ANDROID_NS = "{http://schemas.android.com/apk/res/android}"


class ExportedComponentScanner:
    """
    Detect exported Android components without proper authorization.
    OWASP M3 â€“ Insecure Authentication / Authorization
    """

    COMPONENT_TAGS = [
        "activity",
        "service",
        "receiver",
        "provider",
    ]

    def scan(self, manifest_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        tree = ET.parse(manifest_path)
        root = tree.getroot()

        manifest = root
        app = manifest.find("application")
        if app is None:
            return signals

        target_sdk = self._get_target_sdk(manifest)

        for tag in self.COMPONENT_TAGS:
            for comp in app.findall(tag):
                signal = self._analyze_component(comp, tag, target_sdk, manifest_path)
                if signal:
                    signals.append(signal)

        return signals

    # ------------------------
    # Component analysis
    # ------------------------

    def _analyze_component(self, comp, tag, target_sdk, manifest_path):
        name = comp.get(ANDROID_NS + "name", "UNKNOWN")
        exported = comp.get(ANDROID_NS + "exported")
        permission = comp.get(ANDROID_NS + "permission")

        intent_filters = comp.findall("intent-filter")

        # -------- Rule 1: Explicit exported --------
        if exported == "true" and not permission:
            return VulnerabilitySignal(
                owasp_id="M3",
                category="INSECURE_AUTHORIZATION",
                subtype="exported_component_no_permission",
                source="manifest",
                file=manifest_path,
                evidence=[
                    f"component={tag}",
                    f"name={name}",
                    "exported=true",
                    "permission=NONE",
                ],
                confidence=0.9,
            )

        # -------- Rule 2: Implicit exported (pre-Android 12) --------
        if (
            exported is None
            and intent_filters
            and target_sdk is not None
            and target_sdk < 31
        ):
            return VulnerabilitySignal(
                owasp_id="M3",
                category="INSECURE_AUTHORIZATION",
                subtype="implicitly_exported_component",
                source="manifest",
                file=manifest_path,
                evidence=[
                    f"component={tag}",
                    f"name={name}",
                    "exported=IMPLICIT",
                    f"targetSdk={target_sdk}",
                ],
                confidence=0.7,
            )

        return None

    # ------------------------
    # Utils
    # ------------------------

    def _get_target_sdk(self, manifest) -> int | None:
        uses_sdk = manifest.find("uses-sdk")
        if uses_sdk is None:
            return None

        target = uses_sdk.get(ANDROID_NS + "targetSdkVersion")
        try:
            return int(target) if target else None
        except ValueError:
            return None
