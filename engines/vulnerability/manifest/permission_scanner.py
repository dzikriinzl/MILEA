# engines/vulnerability/manifest/permission_scanner.py

import xml.etree.ElementTree as ET
from typing import List
from engines.vulnerability.models import VulnerabilitySignal

ANDROID_NS = "{http://schemas.android.com/apk/res/android}"


class DangerousPermissionScanner:
    """
    Detect dangerous / sensitive permission usage.
    """

    DANGEROUS_PERMISSIONS = {
        "android.permission.READ_SMS": "privacy_exposure",
        "android.permission.RECEIVE_SMS": "privacy_exposure",
        "android.permission.READ_CONTACTS": "privacy_exposure",
        "android.permission.ACCESS_FINE_LOCATION": "tracking",
        "android.permission.CAMERA": "surveillance",
        "android.permission.RECORD_AUDIO": "eavesdropping",
        "android.permission.READ_EXTERNAL_STORAGE": "data_exposure",
        "android.permission.WRITE_EXTERNAL_STORAGE": "data_tampering",
    }

    def scan(self, manifest_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        tree = ET.parse(manifest_path)
        root = tree.getroot()

        for perm in root.findall("uses-permission"):
            name = perm.get(ANDROID_NS + "name")
            if not name:
                continue

            if name in self.DANGEROUS_PERMISSIONS:
                signals.append(
                    VulnerabilitySignal(
                        owasp_id="M6",
                        category="PRIVACY_RISK",
                        subtype="dangerous_permission",
                        source="manifest",
                        file=manifest_path,
                        evidence=[
                            f"permission={name}",
                            f"risk={self.DANGEROUS_PERMISSIONS[name]}",
                        ],
                        confidence=0.6,
                    )
                )

        return signals
