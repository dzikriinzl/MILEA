# engines/vulnerability/manifest/intent_hijack_scanner.py

import xml.etree.ElementTree as ET
from typing import List
from engines.vulnerability.models import VulnerabilitySignal

ANDROID_NS = "{http://schemas.android.com/apk/res/android}"


class IntentHijackingScanner:
    """
    Detect exported components with implicit intent-filters.
    OWASP M3 â€“ Insecure Authorization
    """

    COMPONENTS = ["activity", "service", "receiver"]

    def scan(self, manifest_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        tree = ET.parse(manifest_path)
        root = tree.getroot()

        for comp in self.COMPONENTS:
            for node in root.findall(f".//{comp}"):
                exported = node.get(ANDROID_NS + "exported")
                permission = node.get(ANDROID_NS + "permission")
                name = node.get(ANDROID_NS + "name")

                if exported != "true":
                    continue

                if permission:
                    continue

                intent_filters = node.findall("intent-filter")
                if not intent_filters:
                    continue

                # implicit intent
                signals.append(
                    VulnerabilitySignal(
                        owasp_id="M3",
                        category="INSECURE_AUTHORIZATION",
                        subtype="implicit_intent_hijack",
                        source="manifest",
                        file=manifest_path,
                        evidence=[
                            f"component={comp}",
                            f"name={name}",
                            "exported=true",
                            "permission=NONE",
                            "implicit intent-filter",
                        ],
                        confidence=0.85,
                    )
                )

        return signals
