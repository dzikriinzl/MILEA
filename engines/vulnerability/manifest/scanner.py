# engines/vulnerability/manifest/scanner.py

import xml.etree.ElementTree as ET
from typing import List

from engines.vulnerability.models import VulnerabilitySignal
from engines.vulnerability.manifest.rules import MANIFEST_RULES


ANDROID_NS = "{http://schemas.android.com/apk/res/android}"


class AndroidManifestScanner:
    """
    AndroidManifest Vulnerability Scanner v1
    Signal-only (NO inference, NO scoring)
    """

    def scan(self, manifest_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        tree = ET.parse(manifest_path)
        root = tree.getroot()

        app = root.find("application")
        if app is None:
            return signals

        app_attrs = {
            "debuggable": app.get(f"{ANDROID_NS}debuggable"),
            "allowBackup": app.get(f"{ANDROID_NS}allowBackup"),
            "usesCleartextTraffic": app.get(
                f"{ANDROID_NS}usesCleartextTraffic"
            ),
        }

        for rule in MANIFEST_RULES:
            try:
                if rule["match"](app_attrs):
                    signals.append(
                        VulnerabilitySignal(
                            owasp_id=rule["owasp"],
                            category=rule["category"],
                            subtype=rule["subtype"],
                            source="manifest",
                            file="AndroidManifest.xml",
                            confidence=0.7,
                            evidence=[
                                f"{k}={v}"
                                for k, v in app_attrs.items()
                                if v
                            ],
                        )
                    )
            except Exception:
                continue

        return signals
