# engines/vulnerability/signals/smali.py
import os
from typing import List

from engines.vulnerability.models import VulnerabilitySignal
from engines.vulnerability.base_scanner import BaseVulnerabilityScanner


class SmaliSignalScanner(BaseVulnerabilityScanner):
    """
    Generic Smali signal scanner (v1).

    - No vulnerability inference
    - No decision / control-flow
    - Keyword & pattern based only
    """

    SIGNAL_PATTERNS = [
        # ---------- M5: Insecure Communication ----------
        {
            "owasp_id": "M5",
            "category": "INSECURE_COMMUNICATION",
            "subtype": "cleartext_http",
            "keywords": ["http://"],
            "confidence": 0.7,
        },
        {
            "owasp_id": "M5",
            "category": "INSECURE_COMMUNICATION",
            "subtype": "webview_insecure_load",
            "keywords": ["loadurl", "loadDataWithBaseURL"],
            "confidence": 0.6,
        },

        # ---------- M10: Weak Cryptography ----------
        {
            "owasp_id": "M10",
            "category": "INSUFFICIENT_CRYPTOGRAPHY",
            "subtype": "weak_cipher",
            "keywords": [
                "cipher.getinstance(\"des\"",
                "cipher.getinstance(\"rc4\"",
                "cipher.getinstance(\"md5\"",
            ],
            "confidence": 0.8,
        },

        # ---------- M9: Insecure Storage ----------
        {
            "owasp_id": "M9",
            "category": "INSECURE_DATA_STORAGE",
            "subtype": "sharedprefs_world_readable",
            "keywords": [
                "mode_world_readable",
                "mode_world_writable",
            ],
            "confidence": 0.9,
        },
    ]

    def scan(self, root_path: str) -> List[VulnerabilitySignal]:
        signals: List[VulnerabilitySignal] = []

        for root, _, files in os.walk(root_path):
            for file in files:
                if not file.endswith(".smali"):
                    continue

                full_path = os.path.join(root, file)
                rel_path = os.path.relpath(full_path, root_path)

                try:
                    with open(full_path, "r", encoding="utf-8", errors="ignore") as f:
                        lines = f.readlines()
                except Exception:
                    continue

                for idx, line in enumerate(lines):
                    l = line.lower().strip()

                    for pattern in self.SIGNAL_PATTERNS:
                        if any(k in l for k in pattern["keywords"]):
                            signals.append(
                                VulnerabilitySignal(
                                    owasp_id=pattern["owasp_id"],
                                    category=pattern["category"],
                                    subtype=pattern["subtype"],
                                    source="smali",
                                    file=rel_path,
                                    line=idx + 1,
                                    code=line.strip(),
                                    evidence=[line.strip()],
                                    confidence=pattern["confidence"],
                                )
                            )

        return signals
