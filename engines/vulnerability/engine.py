from typing import List
from core.evidence.base import Evidence
from engines.vulnerability.findings import VulnerabilityFinding


class _EngineReport:
    """Minimal report wrapper returned by VulnerabilityEngine.run()."""

    def __init__(self, findings: List[VulnerabilityFinding]):
        self.findings = findings

    def summary(self) -> str:
        lines = [f"VulnerabilityEngine Report â€” {len(self.findings)} finding(s)"]
        for f in self.findings:
            lines.append(f"  [{f.severity}] {f.owasp_id} {f.title} (conf={f.confidence:.2f})")
        return "\n".join(lines)


class VulnerabilityEngine:
    """
    STAGE 1: Vulnerability Detection Engine (FINAL)

    INPUT  : List[Evidence]
    OUTPUT : List[VulnerabilityFinding]

    Rules:
    - Evidence-driven ONLY
    - No filesystem access
    - No risk / correlation logic
    """

    def scan_from_evidence(self, evidence: List[Evidence]) -> List[VulnerabilityFinding]:
        findings: List[VulnerabilityFinding] = []

        for ev in evidence:

            # --------------------------------------------------
            # M1: Runtime Command Execution
            # --------------------------------------------------
            if ev.type == "SMALI_RUNTIME_EXEC":
                findings.append(
                    VulnerabilityFinding(
                        owasp_id="M1",
                        title="Command Execution via Runtime.exec",
                        category="Code Execution",
                        subtype="Runtime.exec",
                        severity="HIGH",
                        confidence=ev.confidence,
                        description=(
                            "Application invokes Runtime.exec which may allow "
                            "arbitrary command execution."
                        ),
                        recommendation="Avoid using Runtime.exec with user-controlled input.",
                        remediation="Refactor code to safer APIs.",
                        evidence=[str(ev.payload)],
                        affected_files=[ev.source],
                        references=[
                            "https://owasp.org/www-project-mobile-top-10/2024/"
                        ],
                    )
                )

            # --------------------------------------------------
            # M7: Insecure WebView JavaScript Interface
            # --------------------------------------------------
            elif ev.type == "SMALI_WEBVIEW_JS_INTERFACE":
                findings.append(
                    VulnerabilityFinding(
                        owasp_id="M7",
                        title="Insecure WebView JavaScript Interface",
                        category="Client Code Quality",
                        subtype="WebView",
                        severity="MEDIUM",
                        confidence=ev.confidence,
                        description="addJavascriptInterface exposed to WebView.",
                        recommendation="Remove or restrict JavaScript interfaces.",
                        remediation="Use @JavascriptInterface carefully.",
                        evidence=[str(ev.payload)],
                        affected_files=[ev.source],
                        references=[
                            "https://developer.android.com/reference/android/webkit/WebView"
                        ],
                    )
                )

            # --------------------------------------------------
            # M9: Native Anti-Debug Indicator (NOT protection)
            # --------------------------------------------------
            elif ev.type == "NATIVE_SYMBOL" and ev.payload == "ptrace":
                findings.append(
                    VulnerabilityFinding(
                        owasp_id="M9",
                        title="Native Anti-Debug Logic Detected",
                        category="Reverse Engineering Resistance",
                        subtype="Anti-Debug",
                        severity="LOW",
                        confidence=ev.confidence,
                        description="ptrace symbol detected in native library.",
                        recommendation="Ensure anti-debug logic is safe.",
                        remediation="Review native protection logic.",
                        evidence=[str(ev.payload)],
                        affected_files=[ev.source],
                        references=[],
                    )
                )

        return findings

    def run(self, workspace: str) -> _EngineReport:
        """Convenience entry-point: scan a workspace path and return a report."""
        from engines.vulnerability.unified_scanner import UnifiedSmaliScanner
        from engines.vulnerability.vulnerability_inferer import VulnerabilityInfererV1
        from pathlib import Path

        scanner = UnifiedSmaliScanner()
        signals, _ = scanner.scan_all(Path(workspace))

        inferer = VulnerabilityInfererV1()
        inferred = inferer.infer(signals)

        # convert InferredFindings to VulnerabilityFindings where needed
        findings: List[VulnerabilityFinding] = []
        for item in inferred:
            if isinstance(item, VulnerabilityFinding):
                findings.append(item)
            else:
                findings.append(VulnerabilityFinding(
                    owasp_id=item.owasp_id,
                    title=item.title,
                    category=item.category,
                    subtype=item.subtype,
                    severity=item.severity,
                    confidence=item.confidence,
                    description=item.description,
                    recommendation=item.recommendation,
                    remediation=item.remediation,
                    evidence=item.evidence,
                    affected_files=item.affected_files,
                ))
        return _EngineReport(findings)