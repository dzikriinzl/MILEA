# engines/vulnerability/inferer/m2_supply_chain.py

from typing import List
from engines.vulnerability.findings import VulnerabilityFinding
from engines.vulnerability.models import VulnerabilitySignal
from .base import BaseVulnerabilityInferer


class M2SupplyChainInferer(BaseVulnerabilityInferer):

    @property
    def supported_subtypes(self):
        return {
            "missing_integrity_verification",
            "instrumentation_exposed_sdk",
            "untrusted_third_party_runtime",
            "supply_chain_trust_gap",
        }

    def infer(self, signals, context=None):
        if not context:
            return []

        ara = context.get("ara", {})
        meta = context.get("metadata", {})

        sdk_count = meta.get("sdk_count", 0)
        if sdk_count == 0:
            return []

        anti_tampering = ara.get("ANTI_TAMPERING", {}).get("present", False)
        anti_instr = ara.get("ANTI_INSTRUMENTATION", {}).get("posture", "NONE")
        root = ara.get("ROOT_DETECTION", {}).get("present", False)
        emulator = ara.get("EMULATOR_DETECTION", {}).get("present", False)

        flags = set()

        if not anti_tampering:
            flags.add("missing_integrity_verification")

        if anti_instr in ["NONE", "LOW"]:
            flags.add("instrumentation_exposed_sdk")

        if not root and not emulator:
            flags.add("untrusted_third_party_runtime")

        if (
            "missing_integrity_verification" in flags
            and "instrumentation_exposed_sdk" in flags
        ):
            flags.add("supply_chain_trust_gap")

        findings = []

        for subtype in flags:
            severity = "HIGH" if subtype == "supply_chain_trust_gap" else "MEDIUM"

            findings.append(
                VulnerabilityFinding(
                    owasp_id="M2",
                    title="Inadequate Supply Chain Security",
                    category="SUPPLY_CHAIN",
                    subtype=subtype,
                    severity=severity,
                    confidence=min(0.95, 0.6 + sdk_count * 0.05),
                    description=self._describe(subtype),
                    recommendation=self._recommend(subtype),
                    remediation=self._remediate(subtype),
                    evidence=[
                        f"sdk_count={sdk_count}",
                        f"anti_tampering={anti_tampering}",
                        f"anti_instrumentation={anti_instr}",
                        f"root_detection={root}",
                        f"emulator_detection={emulator}",
                    ],
                    affected_files=[],
                )
            )

        return findings

