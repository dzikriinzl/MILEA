# engines/vulnerability/inferer/m4_input_validation.py

from typing import List, Dict
from engines.vulnerability.models import VulnerabilitySignal
from engines.vulnerability.findings import VulnerabilityFinding
from .base import BaseVulnerabilityInferer


class M4InputValidationInferer(BaseVulnerabilityInferer):

    def supported_subtypes(self):
        return [
            "unvalidated_intent_input",
            "unvalidated_webview_input",
            "untrusted_uri_input",
        ]

    def infer(self, signals):
        findings = []

        grouped = {}
        for s in signals:
            if s.subtype not in self.supported_subtypes():
                continue
            key = (s.subtype, s.file)
            grouped.setdefault(key, []).append(s)

        for (subtype, file), group in grouped.items():
            if len(group) < 10:
                continue

            findings.append(
                VulnerabilityFinding(
                    owasp_id="M4",
                    title="Insufficient Input Validation",
                    category="INSUFFICIENT_INPUT_VALIDATION",
                    subtype=subtype,
                    severity="MEDIUM",
                    confidence=min(0.95, 0.4 + len(group) * 0.01),
                    description="Input is used without sufficient validation.",
                    recommendation="Validate and sanitize all external inputs.",
                    remediation="Apply strict input validation and allowlists.",
                    evidence=[f"{subtype} detected {len(group)} times"],
                    affected_files=[file],
                )
            )

        return findings

