from engines.vulnerability.findings import VulnerabilityFinding
from engines.vulnerability.inferer.base import BaseVulnerabilityInferer


class M7BinaryProtectionInferer(BaseVulnerabilityInferer):
    """
    M7 â€“ Insufficient Binary Protections
    Bridged from ARA (UnifiedProtectionProfile)
    """

    # =========================
    # REQUIRED by abstract base
    # =========================
    def supported_subtypes(self):
        # M7 is NOT signal-driven
        return []

    def infer(self, signals):
        """
        Signal-based inference is intentionally disabled for M7.
        M7 findings MUST come from ARA profile.
        """
        return []

    # =========================
    # ARA-based inference
    # =========================
    def infer_from_ara(self, ara_profile: dict):
        findings = []

        # -------- Root Detection --------
        root = ara_profile.get("ROOT_DETECTION", {})
        if not root.get("present", False):
            findings.append(
                self._finding(
                    subtype="missing_root_detection",
                    title="Missing Root Detection",
                    description="Application lacks root detection, enabling runtime tampering.",
                )
            )

        # -------- Anti-Instrumentation --------
        ai = ara_profile.get("ANTI_INSTRUMENTATION", {})
        if ai.get("posture") in [None, "LOW"]:
            findings.append(
                self._finding(
                    subtype="no_anti_instrumentation",
                    title="Missing Anti-Instrumentation",
                    description="Application does not protect against hooking frameworks.",
                )
            )

        # -------- Anti-Tampering --------
        at = ara_profile.get("ANTI_TAMPERING", {})
        if at.get("posture") in [None, "LOW"]:
            findings.append(
                self._finding(
                    subtype="weak_anti_tampering",
                    title="Weak Anti-Tampering Protection",
                    description="Binary integrity protection is insufficient.",
                )
            )

        # -------- Emulator Detection --------
        ed = ara_profile.get("EMULATOR_DETECTION", {})
        if not ed.get("present", False):
            findings.append(
                self._finding(
                    subtype="missing_emulator_detection",
                    title="Missing Emulator Detection",
                    description="Application can be easily analyzed in emulated environments.",
                )
            )

        # -------- SSL Pinning --------
        ssl = ara_profile.get("SSL_PINNING", {})
        if not ssl.get("present", False):
            findings.append(
                self._finding(
                    subtype="missing_ssl_pinning",
                    title="Missing SSL Pinning",
                    description="Network traffic interception is possible.",
                )
            )

        return findings

    # =========================
    # Helper
    # =========================
    def _finding(self, subtype, title, description):
        return VulnerabilityFinding(
            owasp_id="M7",
            title=title,
            category="INSUFFICIENT_BINARY_PROTECTION",
            subtype=subtype,
            severity="MEDIUM",
            confidence=0.8,
            description=description,
            recommendation="Implement runtime protection and integrity checks.",
            remediation="Add root, anti-hooking, and tamper detection mechanisms.",
            evidence=[],
            affected_files=[],
        )
