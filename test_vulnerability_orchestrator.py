from engines.vulnerability.models import VulnerabilitySignal
from engines.vulnerability.orchestrator import VulnerabilityOrchestrator


def test_orchestrator_routes_correctly():
    signals = [
        VulnerabilitySignal(
            owasp_id="M4",
            category="INSUFFICIENT_INPUT_VALIDATION",
            subtype="intent_extra_unvalidated",
            source="smali",
            file="com/example/MainActivity.smali",
            line=120,
            evidence=["getIntent"],
            confidence=0.6,
        ),
        VulnerabilitySignal(
            owasp_id="M10",
            category="INSUFFICIENT_CRYPTOGRAPHY",
            subtype="weak_hash_md5",
            source="smali",
            file="com/example/Crypto.smali",
            line=44,
            evidence=["MD5"],
            confidence=0.9,
        ),
    ]

    orch = VulnerabilityOrchestrator()
    findings = orch.run(signals)

    assert len(findings) == 2

    subtypes = {f.subtype for f in findings}
    assert "intent_input_unvalidated" in subtypes
    assert "weak_hash_md5" in subtypes
